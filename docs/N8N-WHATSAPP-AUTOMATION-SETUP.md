# N8N + WhatsApp Automation Setup for Corretor Consultor

Este documento detalha como implementar a automaÃ§Ã£o completa de conversÃ£o de leads via N8N e WhatsApp para o sistema de teste grÃ¡tis do Corretor Consultor.

## ðŸ“‹ VisÃ£o Geral do Sistema

O sistema implementa 4 webhooks especÃ­ficos que sÃ£o acionados automaticamente:

1. **user-registered-webhook**: Quando um novo usuÃ¡rio se cadastra
2. **study-completed-webhook**: Quando um usuÃ¡rio completa um estudo
3. **free-trial-limit-reached-webhook**: Quando o limite de 3 estudos Ã© atingido
4. **user-subscribed-webhook**: Quando um usuÃ¡rio assina o plano premium

## ðŸ”— Webhooks Implementados

### 1. User Registered Webhook
**URL**: `https://kxnikregrasjkjntoyhm.supabase.co/functions/v1/user-registered-webhook`

**Payload**:
```json
{
  "event_type": "user_registered",
  "user_data": {
    "user_id": "uuid",
    "email": "user@example.com",
    "full_name": "Nome Completo",
    "phone_number": "+5511999999999",
    "free_studies_limit": 3,
    "insurance_company": "Corretora XYZ",
    "registration_date": "2024-01-01T10:00:00.000Z"
  },
  "message_template": "welcome_new_user"
}
```

### 2. Study Completed Webhook
**URL**: `https://kxnikregrasjkjntoyhm.supabase.co/functions/v1/study-completed-webhook`

**Payload**:
```json
{
  "event_type": "study_completed",
  "user_data": {
    "user_id": "uuid",
    "email": "user@example.com",
    "full_name": "Nome Completo",
    "phone_number": "+5511999999999",
    "free_studies_used": 1,
    "free_studies_remaining": 2,
    "completion_date": "2024-01-01T10:00:00.000Z"
  },
  "message_template": "study_completed_one_remaining" // ou "study_completed_two_remaining"
}
```

### 3. Free Trial Limit Reached Webhook
**URL**: `https://kxnikregrasjkjntoyhm.supabase.co/functions/v1/free-trial-limit-reached-webhook`

**Payload**:
```json
{
  "event_type": "free_trial_limit_reached",
  "user_data": {
    "user_id": "uuid",
    "email": "user@example.com",
    "full_name": "Nome Completo",
    "phone_number": "+5511999999999",
    "limit_reached_date": "2024-01-01T10:00:00.000Z",
    "conversion_opportunity": true
  },
  "message_template": "trial_limit_reached_conversion",
  "priority": "high",
  "campaign_type": "immediate_conversion"
}
```

### 4. User Subscribed Webhook
**URL**: `https://kxnikregrasjkjntoyhm.supabase.co/functions/v1/user-subscribed-webhook`

**Payload**:
```json
{
  "event_type": "user_subscribed",
  "user_data": {
    "user_id": "uuid",
    "email": "user@example.com",
    "full_name": "Nome Completo",
    "phone_number": "+5511999999999",
    "subscription_plan": "pro",
    "subscription_date": "2024-01-01T10:00:00.000Z",
    "conversion_successful": true
  },
  "message_template": "premium_welcome",
  "campaign_type": "welcome_premium"
}
```

## ðŸš€ ConfiguraÃ§Ã£o do N8N

### Passo 1: Configurar VariÃ¡veis de Ambiente
No Supabase, configure a variÃ¡vel de ambiente:
- **N8N_WEBHOOK_URL**: URL do seu webhook principal do N8N

### Passo 2: Criar Webhook Principal no N8N
Crie um webhook que receberÃ¡ todos os eventos e distribuirÃ¡ para os fluxos corretos:

```javascript
// Webhook Trigger Node Configuration
{
  "httpMethod": "POST",
  "path": "corretor-consultor-webhook",
  "responseMode": "responseNode"
}
```

### Passo 3: Criar Switch Node para Distribuir Eventos
Configure um Switch Node para direcionar cada tipo de evento:

```javascript
{
  "conditions": {
    "boolean": [],
    "dateTime": [],
    "number": [],
    "string": [
      {
        "value1": "={{ $json.event_type }}",
        "operation": "equal",
        "value2": "user_registered"
      },
      {
        "value1": "={{ $json.event_type }}",
        "operation": "equal", 
        "value2": "study_completed"
      },
      {
        "value1": "={{ $json.event_type }}",
        "operation": "equal",
        "value2": "free_trial_limit_reached"
      },
      {
        "value1": "={{ $json.event_type }}",
        "operation": "equal",
        "value2": "user_subscribed"
      }
    ]
  }
}
```

## ðŸ“± Fluxos de WhatsApp

### Fluxo 1: Boas-vindas (user_registered)
**Template**: `welcome_new_user`

**Mensagem**:
```
ðŸŽ‰ *OlÃ¡, {{ $json.user_data.full_name }}!*

Bem-vindo ao *Corretor Consultor*! 

VocÃª tem *3 estudos gratuitos* para descobrir como nossa plataforma pode revolucionar suas vendas de seguro de vida.

âœ¨ *O que vocÃª pode fazer:*
â€¢ Criar estudos profissionais em minutos
â€¢ Impressionar seus clientes com anÃ¡lises detalhadas  
â€¢ Aumentar sua taxa de conversÃ£o

ðŸš€ *Comece agora:* https://app.corretorconsultor.com

Qualquer dÃºvida, Ã© sÃ³ responder esta mensagem!
```

### Fluxo 2: Incentivo de Uso (study_completed)
**Template**: `study_completed_two_remaining`

**Mensagem**:
```
ðŸŽ¯ *ParabÃ©ns, {{ $json.user_data.full_name }}!*

VocÃª acabou de completar um estudo no Corretor Consultor!

ðŸ’ª *Ainda restam {{ $json.user_data.free_studies_remaining }} estudos gratuitos* para vocÃª explorar todo o potencial da plataforma.

âœ… *VocÃª jÃ¡ descobriu:*
â€¢ Como criar propostas profissionais
â€¢ O poder das recomendaÃ§Ãµes personalizadas

ðŸ”¥ *Continue experimentando:* https://app.corretorconsultor.com

Aproveite seus estudos restantes!
```

**Template**: `study_completed_one_remaining`

**Mensagem**:
```
âš¡ *{{ $json.user_data.full_name }}, vocÃª estÃ¡ quase lÃ¡!*

*Falta apenas 1 estudo gratuito* para vocÃª explorar completamente o Corretor Consultor!

ðŸŽ¯ *VocÃª jÃ¡ viu como Ã© fÃ¡cil:*
â€¢ Criar estudos profissionais
â€¢ Impressionar seus clientes
â€¢ Aumentar suas vendas

ðŸ’Ž *NÃ£o perca a chance!* Use seu Ãºltimo estudo gratuito e depois continue com estudos ilimitados.

ðŸš€ *Acesse agora:* https://app.corretorconsultor.com
```

### Fluxo 3: ConversÃ£o Imediata (free_trial_limit_reached)
**Template**: `trial_limit_reached_conversion`

**Mensagem**:
```
ðŸš€ *{{ $json.user_data.full_name }}, VOCÃŠ PROVOU QUE FUNCIONA!*

Seus 3 estudos gratuitos no Corretor Consultor terminaram, e vocÃª viu o poder da nossa metodologia!

ðŸ’° *RESULTADOS COMPROVADOS:*
âœ… +300% mais profissional que apresentaÃ§Ãµes bÃ¡sicas
âœ… Clientes impressionados com a qualidade tÃ©cnica  
âœ… Vendas recorrentes garantidas com este mÃ©todo

ðŸ”¥ *CONTINUE DOMINANDO O MERCADO!*

Com estudos ilimitados, vocÃª economiza 40h semanais e gera mais vendas!

ðŸ’Ž *ATIVE O TURBO AGORA:*
ðŸ‘‰ https://app.corretorconsultor.com/pricing

*Apenas R$ 49,99/mÃªs* para estudos ilimitados!

Responda "SIM" se tiver alguma dÃºvida!
```

### Fluxo 4: Boas-vindas Premium (user_subscribed)
**Template**: `premium_welcome`

**Mensagem**:
```
ðŸ‘‘ *BEM-VINDO AO CLUBE PREMIUM, {{ $json.user_data.full_name }}!*

ðŸŽ‰ Sua assinatura foi ativada com sucesso!

âœ¨ *AGORA VOCÃŠ TEM ACESSO A:*
â€¢ ðŸš€ Estudos ilimitados
â€¢ ðŸ“Š Pipeline avanÃ§ado de vendas
â€¢ ðŸŽ¨ PersonalizaÃ§Ã£o com sua marca
â€¢ ðŸ’Ž Recursos exclusivos PRO

ðŸ’ª *PRÃ“XIMOS PASSOS:*
1. Acesse o painel: https://app.corretorconsultor.com
2. Configure sua marca em ConfiguraÃ§Ãµes
3. Comece a criar estudos sem limites!

ðŸ”¥ *DICA PRO:* Com estudos ilimitados, vocÃª pode criar mÃºltiplas propostas para o mesmo cliente e fechar mais vendas!

Bem-vindo Ã  famÃ­lia Premium! ðŸš€
```

## ðŸ“ˆ Fluxo de Follow-up (Opcional)

### Webhook de Follow-up
**URL**: `https://kxnikregrasjkjntoyhm.supabase.co/functions/v1/follow-up-non-converted-webhook`

Configure um fluxo automatizado no N8N que execute periodicamente:

**Schedule Trigger**: Execute diariamente Ã s 10:00h
**HTTP Request**: Chame o webhook de follow-up

```javascript
// ConfiguraÃ§Ã£o do nÃ³ Schedule
{
  "rule": {
    "interval": [
      {
        "field": "cronExpression",
        "expression": "0 10 * * *" // 10:00h todos os dias
      }
    ]
  }
}

// ConfiguraÃ§Ã£o da requisiÃ§Ã£o HTTP
{
  "method": "POST",
  "url": "https://kxnikregrasjkjntoyhm.supabase.co/functions/v1/follow-up-non-converted-webhook",
  "body": {
    "followUpType": "3_days",
    "daysAfterLimit": 3
  }
}
```

### Templates de Follow-up

**Template**: `follow_up_3_days`
```
ðŸ’­ *{{ $json.user_data.full_name }}, como posso ajudar?*

Faz 3 dias que vocÃª testou o Corretor Consultor...

ðŸ¤” *Alguma dÃºvida sobre como usar a plataforma?*

âœ… Posso te ajudar com:
â€¢ Como criar estudos mais eficientes
â€¢ Dicas para impressionar seus clientes
â€¢ EstratÃ©gias para aumentar vendas

ðŸ’¬ *Responda qualquer dÃºvida!*

Ou continue de onde parou: https://app.corretorconsultor.com/pricing
```

**Template**: `follow_up_7_days`
```
ðŸŽ¯ *{{ $json.user_data.full_name }}, uma oportunidade especial!*

*OFERTA ESPECIAL - 7 DIAS APENAS!*

ðŸ”¥ *20% DE DESCONTO* na primeira mensalidade do Corretor Consultor PRO!

âœ¨ *Relembre os benefÃ­cios:*
â€¢ Estudos profissionais ilimitados
â€¢ Pipeline avanÃ§ado de vendas
â€¢ Sua marca personalizada
â€¢ Suporte especializado

ðŸ’° *De R$ 49,99 por apenas R$ 39,99* no primeiro mÃªs!

ðŸ‘‰ *Use o cupom: VOLTA20*
ðŸš€ https://app.corretorconsultor.com/pricing

Oferta vÃ¡lida atÃ© {{ new Date(Date.now() + 7*24*60*60*1000).toLocaleDateString('pt-BR') }}!
```

## ðŸ”§ ConfiguraÃ§Ã£o TÃ©cnica

### 1. API do WhatsApp Business
Configure a integraÃ§Ã£o com WhatsApp Business API ou use serviÃ§os como:
- Twilio WhatsApp API
- Meta WhatsApp Business API
- Evolution API (gratuito)

### 2. VariÃ¡veis de Ambiente no N8N
```env
WHATSAPP_API_URL=sua_url_da_api
WHATSAPP_TOKEN=seu_token
WHATSAPP_PHONE_ID=seu_phone_id
```

### 3. NÃ³ HTTP Request para Envio
```javascript
{
  "method": "POST",
  "url": "{{ $env.WHATSAPP_API_URL }}/messages",
  "headers": {
    "Authorization": "Bearer {{ $env.WHATSAPP_TOKEN }}",
    "Content-Type": "application/json"
  },
  "body": {
    "messaging_product": "whatsapp",
    "to": "{{ $json.user_data.phone_number }}",
    "type": "text",
    "text": {
      "body": "{{ $json.message_content }}"
    }
  }
}
```

## ðŸ“Š MÃ©tricas e Tracking

Implemente tracking para medir:
- Taxa de abertura das mensagens
- Taxa de clique nos links
- Taxa de conversÃ£o por template
- Tempo mÃ©dio para conversÃ£o

## ðŸš¨ ConsideraÃ§Ãµes Importantes

1. **Compliance**: Certifique-se de ter opt-in dos usuÃ¡rios para WhatsApp
2. **Rate Limiting**: Respeite os limites da API do WhatsApp
3. **Fallbacks**: Implemente fallbacks para email se WhatsApp falhar
4. **Testing**: Teste todos os fluxos em ambiente de desenvolvimento
5. **Monitoring**: Configure alertas para webhooks que falharem

## ðŸ”„ Fluxo Completo de ConversÃ£o

```mermaid
graph TD
    A[UsuÃ¡rio se Registra] --> B[Webhook: user_registered]
    B --> C[WhatsApp: Boas-vindas]
    C --> D[UsuÃ¡rio cria 1Âº estudo]
    D --> E[Webhook: study_completed]
    E --> F[WhatsApp: Incentivo]
    F --> G[UsuÃ¡rio cria 2Âº estudo]
    G --> H[Webhook: study_completed]
    H --> I[WhatsApp: Ãšltimo estudo]
    I --> J[UsuÃ¡rio cria 3Âº estudo]
    J --> K[Webhook: free_trial_limit_reached]
    K --> L[WhatsApp: ConversÃ£o]
    L --> M{UsuÃ¡rio assina?}
    M -->|Sim| N[Webhook: user_subscribed]
    M -->|NÃ£o| O[Follow-up 3 dias]
    N --> P[WhatsApp: Boas-vindas Premium]
    O --> Q[Follow-up 7 dias]
    Q --> R[Follow-up 14 dias]
```

Este sistema garante uma jornada completa de conversÃ£o automatizada via WhatsApp, maximizando as chances de converter leads em clientes pagantes.